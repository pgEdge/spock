/* First test whether a table's replication set can be properly manipulated */
SELECT * FROM spock_regress_variables()
\gset
\c :provider_dsn
CREATE TABLE spock.test_387 (x integer PRIMARY KEY);
INSERT INTO spock.test_387 (x) VALUES (1);
SELECT 1 FROM spock.repset_create('repset_387');
 ?column? 
----------
        1
(1 row)

SELECT 1 FROM spock.repset_add_table('repset_387', 'spock.test_387');
ERROR:  relation test_387 cannot be added to any replication set
DETAIL:  table is in the ignored schema spock
HINT:  Move this relation to a schema allowed for replication
-- This also states that each test should clean their objects before the end.
SELECT nspname,relname,set_name FROM spock.TABLES
ORDER BY nspname,relname,set_name COLLATE "C";
 nspname | relname | set_name 
---------+---------+----------
(0 rows)

/*
 * TODO: check, if table in a legal schema, but dependent sequence is not.
 */
ALTER TABLE spock.test_387 SET SCHEMA public;
ALTER TABLE public.test_387 ADD COLUMN y serial;
SELECT 1 FROM spock.repset_add_table('repset_387', 'test_387');
 ?column? 
----------
        1
(1 row)

SELECT nspname,relname,set_name FROM spock.TABLES
ORDER BY nspname,relname,set_name COLLATE "C";
 nspname | relname  |  set_name  
---------+----------+------------
 public  | test_387 | repset_387
(1 row)

\c :subscriber_dsn
SELECT 1 FROM spock.sub_create(
  subscription_name := 'sub_387',
  provider_dsn := (SELECT provider_dsn FROM spock_regress_variables()) || ' user=super'	,
  replication_sets := '{repset_387}',
  synchronize_structure := false,
  synchronize_data := true,
  skip_schema := '{}'
);
 ?column? 
----------
        1
(1 row)

SET statement_timeout = '180s'; -- enough to stay away of false positives
DO $$
DECLARE
  cnt integer;
BEGIN
  LOOP
    SELECT count(*) FROM spock.sub_show_status(subscription_name := 'sub_387')
    WHERE status = 'down' INTO cnt;

    EXIT WHEN cnt > 0;
    END LOOP;
END; $$;
SELECT 1 FROM spock.sub_drop('sub_387');
 ?column? 
----------
        1
(1 row)

\c :provider_dsn
SELECT spock.repset_drop('repset_387');
 repset_drop 
-------------
 t
(1 row)

DROP TABLE test_387;
