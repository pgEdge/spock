FROM ghcr.io/pgedge/base-test-image:latest

# Base image already has Rocky Linux, PostgreSQL, and pgedge installed
# We only need to compile Spock extension against the existing PostgreSQL
# Base image ends as USER pgedge, but we need root for installation
USER root

ARG PGVER
ARG MAKE_JOBS=4

ENV PGVER=$PGVER
ENV PATH="/home/pgedge/pgedge/pg${PGVER}/bin:${PATH}"
ENV LD_LIBRARY_PATH="/home/pgedge/pgedge/pg${PGVER}/lib:${LD_LIBRARY_PATH}"
ENV PG_CONFIG="/home/pgedge/pgedge/pg${PGVER}/bin/pg_config"
ENV SPOCK_SOURCE_DIR="/home/pgedge/spock"

# Copy spock source code and set proper ownership
COPY . /home/pgedge/spock
RUN chown -R pgedge:pgedge /home/pgedge/spock

WORKDIR /home/pgedge

# Determine PostgreSQL version and clone repository
RUN LATEST_TAG=$(git ls-remote --tags https://github.com/postgres/postgres.git | \
				grep "refs/tags/REL_${PGVER}_" | \
				sed 's|.*refs/tags/||' | \
				tr '_' '.' | \
				sort -V | \
				tail -n 1 | \
				tr '.' '_') && \
			echo "Using PostgreSQL tag: $LATEST_TAG" && \
			git clone --branch $LATEST_TAG --depth 1 https://github.com/postgres/postgres /home/pgedge/postgres && \
			chmod -R a+w /home/pgedge/postgres

# Install pgedge (run as pgedge user, not root)
RUN echo "Setting up pgedge..." && \
    curl -fsSL https://pgedge-download.s3.amazonaws.com/REPO/install.py -o /home/pgedge/install.py && \
    chown pgedge:pgedge /home/pgedge/install.py && \
    su - pgedge -c "python3 /home/pgedge/install.py"

WORKDIR /home/pgedge/postgres

RUN for patchfile in /home/pgedge/spock/patches/${PGVER}/*; do \
		patch -p1 --verbose < $patchfile; \
	done

# Compile PostgreSQL
RUN echo "==========Compiling Modified PostgreSQL==========" && \
    ./configure \
        --prefix="/home/pgedge/pgedge/pg${PGVER}" \
        --disable-rpath \
        --with-zstd \
        --with-lz4 \
        --with-icu \
        --with-libxslt \
        --with-libxml \
        --with-uuid=ossp \
        --with-gssapi \
        --with-ldap \
        --with-pam \
        --enable-debug \
        --enable-dtrace \
        --with-llvm \
        --with-openssl \
        --with-systemd \
        --enable-tap-tests \
        --with-python \
        --enable-cassert \
        PYTHON=/usr/bin/python3.9 \
        BITCODE_CFLAGS="-gdwarf-5 -O0 -fforce-dwarf-frame" \
        CFLAGS="-g -O0" && \
    make -j${MAKE_JOBS} && \
    make -C contrib -j${MAKE_JOBS} && \
    make install && \
    make -C contrib install

# Compile Spock
WORKDIR /home/pgedge/spock
RUN echo "==========Compiling Spock==========" && \
    make clean && \
    make -j${MAKE_JOBS} && \
    make install && \
    echo "==========Spock build complete=========="

#-----------------------------------------
# Copy test scripts and switch to pgedge user for runtime
COPY --chmod=755 tests/docker/*.sh /home/pgedge/

WORKDIR /home/pgedge/
# Switch back to pgedge user for container runtime (testing, etc.)
USER pgedge

CMD ["/home/pgedge/entrypoint.sh"]
