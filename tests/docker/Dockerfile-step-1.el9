FROM ghcr.io/pgedge/base-test-image:latest

# Base image already has Rocky Linux, PostgreSQL, and pgedge installed
# We only need to compile Spock extension against the existing PostgreSQL

# Base image ends as USER pgedge, but we need root for installation
USER root

ARG PGVER
ARG MAKE_JOBS=4

ENV PGVER=$PGVER

ENV PATH="/home/pgedge/pgedge/pg${PGVER}/bin:${PATH}"
ENV LD_LIBRARY_PATH="/home/pgedge/pgedge/pg${PGVER}/lib:${LD_LIBRARY_PATH}"
ENV PG_CONFIG="/home/pgedge/pgedge/pg${PGVER}/bin/pg_config"
ENV SPOCK_SOURCE_DIR="/home/pgedge/spock"

# Copy spock source code and set proper ownership
COPY . /home/pgedge/spock
RUN chown -R pgedge:pgedge /home/pgedge/spock

# Compile Spock against the pre-installed PostgreSQL
WORKDIR /home/pgedge/spock
RUN echo "==========Compiling Spock==========" && \
    make clean && \
    make -j${MAKE_JOBS} && \
    make install && \
    echo "==========Spock build complete=========="

#-----------------------------------------
# Copy test scripts and switch to pgedge user for runtime
COPY --chmod=755 tests/docker/*.sh /home/pgedge/

WORKDIR /home/pgedge/
# Switch back to pgedge user for container runtime (testing, etc.)
USER pgedge

CMD ["/home/pgedge/entrypoint.sh"]
