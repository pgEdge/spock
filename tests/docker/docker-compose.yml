services:
  pgedge-n1:
    container_name: n1
    hostname: n1
    image: spock
    build:
      context: ../..
      dockerfile: tests/docker/Dockerfile-step-1.el9
      args:
        - PGVER=${PGVER:-17}
        - MAKE_JOBS=${MAKE_JOBS:-4}
        - BASE_IMAGE=${BASE_IMAGE:-base-test-image:latest}
    environment:
      - HOSTNAME=n1
      - PEER_NAMES=n2,n3
      - TZ=America/Toronto
    env_file:
      - pgedge.env
    ports:
      - '15432:5432'
    # Enable core dumps for crash debugging
    cap_add:
      - SYS_PTRACE    # Required for debugging with gdb
      - SYS_ADMIN     # Required to set /proc/sys/kernel/core_pattern
    ulimits:
      core:
        soft: -1
        hard: -1
    # Mount volume for core dumps (persists across container restarts)
    volumes:
      - ./cores/n1:/cores
      - .:/home/pgedge/tests
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h /tmp -p $$DBPORT -U $$DBUSER -d $$DBNAME && test -f /tmp/spock_init_complete"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  pgedge-n2:
    container_name: n2
    hostname: n2
    image: spock
    depends_on:
      pgedge-n1:
        condition: service_healthy
    build:
      context: ../..
      dockerfile: tests/docker/Dockerfile-step-1.el9
      args:
        - PGVER=${PGVER:-17}
        - MAKE_JOBS=${MAKE_JOBS:-4}
        - BASE_IMAGE=${BASE_IMAGE:-base-test-image:latest}
    environment:
      - HOSTNAME=n2
      - PEER_NAMES=n1,n3
      - TZ=America/Toronto
    env_file:
      - pgedge.env
    ports:
      - '15433:5432'
    # Enable core dumps for crash debugging
    cap_add:
      - SYS_PTRACE    # Required for debugging with gdb
      - SYS_ADMIN     # Required to set /proc/sys/kernel/core_pattern
    ulimits:
      core:
        soft: -1
        hard: -1
    # Mount volume for core dumps (persists across container restarts)
    volumes:
      - ./cores/n2:/cores
      - .:/home/pgedge/tests
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h /tmp -p $$DBPORT -U $$DBUSER -d $$DBNAME && test -f /tmp/spock_init_complete"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  pgedge-n3:
    container_name: n3
    hostname: n3
    image: spock
    depends_on:
      pgedge-n2:
        condition: service_healthy
    build:
      context: ../..
      dockerfile: tests/docker/Dockerfile-step-1.el9
      args:
        - PGVER=${PGVER:-17}
        - MAKE_JOBS=${MAKE_JOBS:-4}
        - BASE_IMAGE=${BASE_IMAGE:-base-test-image:latest}
    environment:
      - HOSTNAME=n3
      - PEER_NAMES=n1,n2
      - TZ=America/Toronto
    env_file:
      - pgedge.env
    ports:
      - '15434:5432'
    # Enable core dumps for crash debugging
    cap_add:
      - SYS_PTRACE    # Required for debugging with gdb
      - SYS_ADMIN     # Required to set /proc/sys/kernel/core_pattern
    ulimits:
      core:
        soft: -1
        hard: -1
    # Mount volume for core dumps (persists across container restarts)
    volumes:
      - ./cores/n3:/cores
      - .:/home/pgedge/tests
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h /tmp -p $$DBPORT -U $$DBUSER -d $$DBNAME && test -f /tmp/spock_init_complete"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
