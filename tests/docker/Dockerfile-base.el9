# syntax=docker/dockerfile:1

# ==============================================================================
# Base Test Image for pgEdge Products Development and Testing
# ==============================================================================
#
# Description:
#   This image provides a Rocky Linux 9 base with all necessary dependencies
#   for building and testing PostgreSQL extensions, specifically pgEdge Spock.
#
# Included Components:
#   - Rocky Linux 9 base OS with development tools
#   - PostgreSQL build dependencies (compilers, libraries, etc.)
#   - Testing frameworks (Perl Test::More)
#   - SSH server for testing connectivity
#   - pgedge user with sudo privileges
#
# Build Target: ghcr.io/pgedge/base-test-image:latest
# ==============================================================================

# Use the latest Rocky Linux 9 base image
FROM rockylinux:9

# Define build arguments for customization
ARG PGEDGE_USER=pgedge

# Set metadata labels
LABEL org.opencontainers.image.title="pgEdge Dev Base Test Image" \
      org.opencontainers.image.description="Base image for pgEdge development and testing" \
      org.opencontainers.image.vendor="pgEdge" \
      org.opencontainers.image.maintainer="andrei.lepikhov@pgedge.com" \
      org.opencontainers.image.licenses="BSD"

# ==============================================================================
# System Update and Base Development Tools Installation
# ==============================================================================
RUN set -eux; \
    dnf -y update; \
    dnf -y upgrade; \
    dnf -y groupinstall "Development Tools"; \
    dnf clean all; \
    rm -rf /var/cache/dnf/*

# ==============================================================================
# User Creation and Configuration
# ==============================================================================
RUN set -eux; \
    useradd -m -s /bin/bash ${PGEDGE_USER}; \
    echo "${PGEDGE_USER}:asdf" | chpasswd; \
    echo "${PGEDGE_USER} ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/${PGEDGE_USER}; \
    chmod 0440 /etc/sudoers.d/${PGEDGE_USER}; \
    chown -R ${PGEDGE_USER}:${PGEDGE_USER} /home/${PGEDGE_USER}

# ==============================================================================
# PostgreSQL Build Dependencies and Testing Tools
# ==============================================================================
# Install all required packages in a single RUN to minimize layers
RUN set -eux; \
    dnf install --allowerasing --enablerepo=crb -y \
        bind-utils \
        bison \
        clang \
        curl \
        cyrus-sasl-gssapi \
        flex \
        gcc \
        git \
        jansson-devel \
        krb5-devel \
        libicu-devel \
        libpq \
        libpq-devel \
        libuuid-devel \
        libxml2-devel \
        libxslt-devel \
        llvm \
        llvm-devel \
        lz4-devel \
        make \
        nc \
        openldap-devel \
        openssh-clients \
        openssh-server \
        openssl-devel \
        pam-devel \
        perl \
        perl-App-cpanminus \
        perl-devel \
        perl-IPC-Run \
        pkgconfig \
        procps \
        python3 \
        python3-devel \
        readline-devel \
        sudo \
        systemd-devel \
        unzip \
        uuid-devel \
        vim \
        zlib-devel \
        zstd-devel; \
    dnf clean all; \
    rm -rf /var/cache/dnf/* /tmp/* /var/tmp/*

# ==============================================================================
# Perl Testing Dependencies
# ==============================================================================
# Note: perl-IPC-Run is already installed via dnf above, only installing Test::More
RUN set -eux; \
    cpanm Test::More; \
    rm -rf /root/.cpanm

# ==============================================================================
# SSH Configuration for Testing
# ==============================================================================
# Switch to pgedge user for SSH setup (security best practice)
USER ${PGEDGE_USER}
RUN set -eux; \
    mkdir -p ~/.ssh; \
    ssh-keygen -t ed25519 -N "" -f ~/.ssh/id_ed25519 -C "${PGEDGE_USER}@localhost"; \
    cat ~/.ssh/id_ed25519.pub >> ~/.ssh/authorized_keys; \
    chmod 700 ~/.ssh; \
    chmod 600 ~/.ssh/authorized_keys ~/.ssh/id_ed25519

# ==============================================================================
# Working Directory and Final Setup
# ==============================================================================
WORKDIR /home/${PGEDGE_USER}
