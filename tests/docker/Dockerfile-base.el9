# syntax=docker/dockerfile:1

# ==============================================================================
# Base Test Image for pgEdge Products Development and Testing
# ==============================================================================
#
# Description:
#   This image provides a Rocky Linux 9 base with all necessary dependencies
#   for building and testing PostgreSQL extensions, specifically pgEdge Spock.
#
# Included Components:
#   - Rocky Linux 9 base OS with development tools
#   - PostgreSQL build dependencies (compilers, libraries, etc.)
#   - Testing frameworks (Perl Test::More)
#   - SSH server for testing connectivity
#   - pgedge user with sudo privileges
#
# Build Target: ghcr.io/pgedge/base-test-image:latest
# ==============================================================================

# Use the latest Rocky Linux 9 base image
FROM rockylinux:9

# Define build arguments for customization and reproducibility
ARG PGEDGE_USER=pgedge
ARG BUILD_DATE
ARG GIT_COMMIT
ARG GIT_BRANCH
ARG ROCKYLINUX_VERSION

# Set metadata labels for reproducibility
LABEL org.opencontainers.image.title="pgEdge Dev Base Test Image" \
      org.opencontainers.image.description="Base image for pgEdge development and testing" \
      org.opencontainers.image.vendor="pgEdge" \
      org.opencontainers.image.maintainer="andrei.lepikhov@pgedge.com" \
      org.opencontainers.image.licenses="BSD" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${GIT_COMMIT}" \
      org.opencontainers.image.source="https://github.com/pgedge/spock" \
      com.pgedge.base-os.version="${ROCKYLINUX_VERSION}" \
      com.pgedge.git.branch="${GIT_BRANCH}"

# ==============================================================================
# Build Information for Reproducibility
# ==============================================================================
RUN set -eux && \
    mkdir -p /etc/pgedge && \
    printf "pgEdge Base Test Image Build Information\n" > /etc/pgedge/build-info.txt && \
    printf "=========================================\n\n" >> /etc/pgedge/build-info.txt && \
    printf "Build Date: %s\n" "${BUILD_DATE:-unknown}" >> /etc/pgedge/build-info.txt && \
    printf "Git Commit: %s\n" "${GIT_COMMIT:-unknown}" >> /etc/pgedge/build-info.txt && \
    printf "Git Branch: %s\n" "${GIT_BRANCH:-unknown}" >> /etc/pgedge/build-info.txt && \
    printf "Rocky Linux: %s\n" "${ROCKYLINUX_VERSION:-unknown}" >> /etc/pgedge/build-info.txt && \
    printf "\nTo reproduce this exact build:\n" >> /etc/pgedge/build-info.txt && \
    printf "  git clone https://github.com/pgedge/spock.git\n" >> /etc/pgedge/build-info.txt && \
    printf "  git checkout %s\n" "${GIT_COMMIT:-unknown}" >> /etc/pgedge/build-info.txt && \
    printf "  docker build -f tests/docker/Dockerfile-base.el9 \\\\\n" >> /etc/pgedge/build-info.txt && \
    printf "    --build-arg BUILD_DATE=%s \\\\\n" "${BUILD_DATE:-unknown}" >> /etc/pgedge/build-info.txt && \
    printf "    --build-arg GIT_COMMIT=%s \\\\\n" "${GIT_COMMIT:-unknown}" >> /etc/pgedge/build-info.txt && \
    printf "    --build-arg GIT_BRANCH=%s .\n" "${GIT_BRANCH:-unknown}" >> /etc/pgedge/build-info.txt && \
    printf "\n" >> /etc/pgedge/build-info.txt && \
    cat /etc/pgedge/build-info.txt

# ==============================================================================
# System Update and Base Development Tools Installation
# ==============================================================================
RUN set -eux && \
    dnf -y upgrade && \
    dnf -y install sudo && \
    dnf -y groupinstall "Development Tools" && \
    dnf clean all && \
    rm -rf /var/cache/dnf/*

# ==============================================================================
# User Creation and Configuration
# ==============================================================================
RUN set -eux && \
    useradd -m -s /bin/bash ${PGEDGE_USER} && \
    echo "${PGEDGE_USER}:asdf" | chpasswd && \
    echo "${PGEDGE_USER} ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/${PGEDGE_USER} && \
    chmod 0440 /etc/sudoers.d/${PGEDGE_USER} && \
    chown -R ${PGEDGE_USER}:${PGEDGE_USER} /home/${PGEDGE_USER}

# ==============================================================================
# PostgreSQL Build Dependencies and Testing Tools
# ==============================================================================
# Install all required packages in a single RUN to minimize layers
RUN set -eux && \
    dnf install --allowerasing --enablerepo=crb -y \
        bind-utils \
        bison \
        clang \
        curl \
        cyrus-sasl-gssapi \
        flex \
        gcc \
        git \
        jansson-devel \
        krb5-devel \
        libicu-devel \
        libpq \
        libpq-devel \
        libuuid-devel \
        libxml2-devel \
        libxslt-devel \
        llvm \
        llvm-devel \
        lz4-devel \
        make \
        nc \
        openldap-devel \
        openssh-clients \
        openssh-server \
        openssl-devel \
        pam-devel \
        perl \
        perl-devel \
        perl-IPC-Run \
        perl-Test-Simple \
        pkgconfig \
        procps \
        python3 \
        python3-devel \
        readline-devel \
        systemd-devel \
        unzip \
        uuid-devel \
        zlib-devel \
        libzstd-devel && \
    dnf clean all && \
    rm -rf /var/cache/dnf/* /tmp/* /var/tmp/*

# ==============================================================================
# SSH Configuration for Testing
# ==============================================================================
# Switch to pgedge user for SSH setup (security best practice)
USER ${PGEDGE_USER}
RUN set -eux && \
    mkdir -p ~/.ssh && \
    ssh-keygen -t ed25519 -N "" -f ~/.ssh/id_ed25519 -C "${PGEDGE_USER}@localhost" && \
    cat ~/.ssh/id_ed25519.pub >> ~/.ssh/authorized_keys && \
    chmod 700 ~/.ssh && \
    chmod 600 ~/.ssh/authorized_keys ~/.ssh/id_ed25519

# ==============================================================================
# Working Directory and Final Setup
# ==============================================================================
WORKDIR /home/${PGEDGE_USER}
