# Use Ubuntu as the base image
FROM ubuntu:22.04

# Set non-interactive mode for package installations
ENV DEBIAN_FRONTEND=noninteractive

# Set up PostgreSQL environment variables dynamically
ARG PG_VERSION
ENV PGPORT="54${PG_VERSION}"
ENV PGDATA="/var/lib/postgresql/data-${PG_VERSION}"
ENV POSTGRES_USER=postgres
ENV POSTGRES_DB=postgres
ENV PG_VER="${PG_VERSION}"

# Install required dependencies
RUN apt-get update && apt-get install -y \
    sudo \
    openssh-server \
    git \
    patch \
    build-essential \
    libreadline-dev \
    zlib1g-dev \
    bison \
    flex \
    curl \
    ca-certificates \
    gcc \
    wget \
    libicu-dev \
    && rm -rf /var/lib/apt/lists/*

ARG GITHUB_TOKEN
ENV GITHUB_TOKEN=${GITHUB_TOKEN}

# Clone PostgreSQL source first before applying patches
RUN git clone https://github.com/postgres/postgres.git /home/postgres/postgres-source && \
    cd /home/postgres/postgres-source && \
    git fetch --tags && \
    LATEST_TAG=$(git tag -l "REL_${PG_VERSION}*" | grep -Eo 'REL_[0-9]+_[0-9]+(_[0-9]+)?' | sort -V | tail -n 1) && \
    git checkout "$LATEST_TAG"

# Clone spock-private repository and apply patches
RUN git clone https://x-access-token:${GITHUB_TOKEN}@github.com/pgedge/spock-private.git /home/postgres/spock-private && \
    cd /home/postgres/spock-private && \
    ls -la && \
    cd /home/postgres/postgres-source && \
    PATCH_DIR="/home/postgres/spock-private/patches" && \
    if compgen -G "$PATCH_DIR/pg${PG_VERSION}-*.diff" > /dev/null; then \
      for PATCH_FILE in $PATCH_DIR/pg${PG_VERSION}-*.diff; do \
        echo "Applying patch with git apply: $PATCH_FILE"; \
        git apply "$PATCH_FILE" && echo "Successfully applied: $PATCH_FILE" || { echo "Failed to apply: $PATCH_FILE"; exit 1; }; \
      done; \
    else \
      echo "No patches found for pg$PG_VERSION."; \
    fi

# Configure, build, and install PostgreSQL
RUN cd /home/postgres/postgres-source && \
    ./configure --prefix=/usr/local/pgsql --without-icu && \
    make -j$(nproc) && \
    sudo make install

# Create postgres user and group
RUN groupadd -r postgres && useradd -r -g postgres postgres

# Ensure correct ownership for PostgreSQL data directory
RUN mkdir -p "$PGDATA" && chown -R postgres:postgres "$PGDATA"

# Switch to postgres user and initialize the database
USER postgres
RUN if [ ! -f "$PGDATA/PG_VERSION" ]; then \
      echo "Running initdb for PostgreSQL $PG_VERSION..."; \
      /usr/local/pgsql/bin/initdb -D "$PGDATA"; \
    fi

# Switch back to root
USER root

# Locate pg_config and add it to the PATH
RUN PG_CONFIG_PATH=$(find /usr/local/pgsql -type f -name pg_config | head -n 1) && \
    if [ -z "$PG_CONFIG_PATH" ]; then \
      echo 'Error: pg_config not found' && exit 1; \
    fi && \
    PG_BIN_DIR=$(dirname "$PG_CONFIG_PATH") && \
    echo "Found pg_config in: $PG_BIN_DIR" && \
    echo "export PATH=$PG_BIN_DIR:\$PATH" >> ~/.bashrc && \
    echo "export PATH=$PG_BIN_DIR:\$PATH" >> ~/.profile && \
    echo "pg_config location successfully added to PATH" && \
    export PATH=$PG_BIN_DIR:$PATH && \
    pg_config

# Compile and install Spock extension
RUN cd /home/postgres/spock-private && \
    make && sudo make install

# Set shared_preload_libraries and track_commit_timestamp
RUN /usr/local/pgsql/bin/psql -d postgres -p "$PGPORT" -c "ALTER SYSTEM SET shared_preload_libraries TO 'spock';" && \
    /usr/local/pgsql/bin/psql -d postgres -p "$PGPORT" -c "ALTER SYSTEM SET track_commit_timestamp TO 'on';"

# Restart PostgreSQL to apply changes
RUN /usr/local/pgsql/bin/pg_ctl -D "$PGDATA" -o "-p $PGPORT" restart && sleep 5

# Verify PostgreSQL is running
RUN /usr/local/pgsql/bin/pg_isready -p "$PGPORT"

# Create Spock extension
RUN /usr/local/pgsql/bin/psql -d postgres -p "$PGPORT" -c "CREATE EXTENSION spock;"

# Switch back to root user
USER root

# Expose the PostgreSQL port
EXPOSE $PGPORT

# Start PostgreSQL at container startup
CMD ["/usr/local/pgsql/bin/postgres", "-D", "/var/lib/postgresql/data-${PG_VERSION}"]

