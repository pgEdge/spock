name: Regression Tests and Spockbench
run-name: Running Regression Tests and Spockbench

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]


permissions:
  contents: read

jobs:
  pull-and-test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        pgver: [15, 16, 17]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout spock
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Checkout spockbench
        uses: actions/checkout@v4
        with:
          repository: pgedge/spockbench
          token: ${{ secrets.GITHUB_TOKEN }}
          path: spockbench
          ref: master

      - name: Add permissions
        run: |
          sudo chmod -R a+w ${GITHUB_WORKSPACE}

      - name: Set up Docker
        # Codacy wants us to use full commit SHA. This is for v3
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Set up docker compose
        # Codacy wants us to use full commit SHA. This is for v1
        uses: docker/setup-compose-action@364cc21a5de5b1ee4a7f5f9d3fa374ce0ccde746 # v1
        with:
          version: latest

      - name: Build docker container
        run: |
          cd ${GITHUB_WORKSPACE}/
          echo PG_VER=${{ matrix.pgver }} >> tests/docker/pgedge.env
          docker build \
            --build-arg PGVER=${{ matrix.pgver }} \
            -t spock -f tests/docker/Dockerfile.el9 .

      - name: Run regression tests
        run: |
          docker run -e PGVER=${{ matrix.pgver }} spock /home/pgedge/run-spock-regress.sh

      - name: Run TAP tests
        run: |
          docker run -e PGVER=${{ matrix.pgver }} --workdir=/home/pgedge/spock/tests/tap \
              spock /home/pgedge/spock/tests/tap/run_tests.sh

      - name: Start docker
        run: |
          cd ${GITHUB_WORKSPACE}/tests/docker/
          echo PG_VER=${{ matrix.pgver }} >> pgedge.env
          docker compose up

      - name: Check spockbench output
        run: |
          cd ${GITHUB_WORKSPACE}/tests/docker
          ./check-outputs.sh

